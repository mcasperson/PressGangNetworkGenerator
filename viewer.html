
<!DOCTYPE html>
<html lang="en">
	<head>
		<title>PressGang Visualization</title>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
		<script type="application/javascript" src="http://code.jquery.com/jquery-2.0.3.min.js"></script>
		<style>
			body {
				color: #cccccc;
				font-family:Monospace;
				font-size:13px;
				text-align:center;

				background-color: #050505;
				margin: 0px;
				overflow: hidden;
			}

			#info {
				position: absolute;
				top: 0px; width: 100%;
				padding: 5px;
			}

			a {

				color: #0080ff;
			}
			
			.productTable {
				position: absolute;
				top: 8px;
				left: 8px;
				bottom: 8px;
				overflow-y: scroll;
			}

		</style>
	</head>
	<body>
		<div id="table" class="productTable"></div>
		<div id="container"></div>
		<script src="three.min.js"></script>
		<script src="Detector.js"></script>
		<script src="extradata.js"></script>
		<script src="TrackballControls.js"></script>
		
		<script type="x-shader/x-vertex" id="vertexshader">

			uniform float amplitude;
			attribute float size;
			attribute vec3 customColor;

			varying vec3 vColor;

			void main() {

				vColor = customColor;

				vec4 mvPosition = modelViewMatrix * vec4( position, 1.0 );

				//gl_PointSize = size;
				gl_PointSize = size * ( 300.0 / length( mvPosition.xyz ) );

				gl_Position = projectionMatrix * mvPosition;

			}

		</script>
		
		<script type="x-shader/x-fragment" id="fragmentshader">

			uniform vec3 color;
			uniform sampler2D texture;

			varying vec3 vColor;

			void main() {

				gl_FragColor = vec4( color * vColor, 1.0 );
				gl_FragColor = gl_FragColor * texture2D( texture, gl_PointCoord );

			}

		</script>

		<script>
			/*
			 * Generate the LAY file using:
			 * java -Xmx768M -cp CCVisu.jar ccvisu.CCVisu -i topics.rsf -outformat LAY -iter 100 -dim 3 > topics.lay
			 * Run this page locally using:
			 * chrome --allow-file-access-from-files
			 */
			

			if ( ! Detector.webgl ) Detector.addGetWebGLMessage();

			var container, stats;

			var camera, scene, renderer;

			var mesh;
			
			var topics = [];
			
			$.ajax({
			  dataType: "text",
			  url: "topics.lay",
			  success: function(topicData) {
				var lines = topicData.split("\n");
				for (var lineIndex = 0, lineCount = lines.length; lineIndex < lineCount; ++lineIndex) {
					if (lines[lineIndex].lenth != 0 && lines[lineIndex].substr(0, 1) != "#") {
						var topicDetails = lines[lineIndex].split("\t");
						if (topicDetails.length == 8) {
							topics.push({id: Number(topicDetails[5]), x: Number(topicDetails[1]), y: Number(topicDetails[2]), z: Number(topicDetails[3]), size: Number(topicDetails[4])});
						}
					}
				}				
				
				init();
				animate();
			  }
			});
			
			function init() {

				container = document.getElementById( 'container' );

				//

				camera = new THREE.PerspectiveCamera( 27, window.innerWidth / window.innerHeight, 5, 100000 );
				camera.position.z = 7500;
				
				setupControls();

				scene = new THREE.Scene();
				
				attributes = {
	
					size: {	type: 'f', value: [] },
					customColor: { type: 'c', value: [] }
	
				};
	
				uniforms = {
	
					amplitude: { type: "f", value: 1.0 },
					color:     { type: "c", value: new THREE.Color( 0xffffff ) },
					texture:   { type: "t", value: THREE.ImageUtils.loadTexture( "particle.png" ) },
	
				};				
				
				var shaderMaterial = new THREE.ShaderMaterial( {

					uniforms: 		uniforms,
					attributes:     attributes,
					vertexShader:   document.getElementById( 'vertexshader' ).textContent,
					fragmentShader: document.getElementById( 'fragmentshader' ).textContent,
	
					blending: 		THREE.AdditiveBlending,
					depthTest: 		false,
					transparent:	true
	
				});
				
				var particleCount = topics.length;
				
				// Assign colours to products
				var table = document.getElementById("table");
				extraData.productColors = {};
				var majorColor = 32;
				var minorColor = 1;
				for (var productIndex = 0, productCount = extraData.products.length; productIndex < productCount; ++productIndex) {
						
						var colour = new THREE.Color();
						var random = Math.random();
						
						if (random < 0.3) {
							colour.setRGB(Math.random() * majorColor, Math.random() * minorColor, Math.random() * minorColor);
						} else if (random > 0.6) {
							colour.setRGB(Math.random() * minorColor, Math.random() * minorColor, Math.random() * majorColor);
						} else {
							colour.setRGB(Math.random() * minorColor, Math.random() * majorColor, Math.random() * minorColor);
						}
						
						extraData.productColors[extraData.products[productIndex]] = colour;
						var tableChild = document.createElement("div");
						tableChild.innerText = extraData.products[productIndex];
						tableChild.style.color = colour.getStyle();
						table.appendChild(tableChild);
				}

				// create the particle variables
				var particles = new THREE.Geometry();
				var values_size = attributes.size.value;
				var values_color = attributes.customColor.value;
				    
				// now create the individual particles
				for(var p = 0; p < particleCount; p++) {

					var pX = topics[p].x,
						pY = topics[p].y,
						pZ = topics[p].z,
						particle = new THREE.Vector3(pX, pY, pZ);
					  
					values_size[ p ] = 50 + (10 * topics[p].size);
					//values_size[ p ] = 50 * (extraData[topics[p].id] ? extraData[topics[p].id].products.length - 1 : 0);
					
					var r = 0, g = 0, b = 0;

					if (extraData[topics[p].id]) {
						var products = extraData[topics[p].id].products;
						for (var topicProductIndex = 0, topicProductCount = products.length; topicProductIndex < topicProductCount; ++topicProductIndex) {
							r += extraData.productColors[products[topicProductIndex]].r;
							g += extraData.productColors[products[topicProductIndex]].g;
							b += extraData.productColors[products[topicProductIndex]].b;
						}
					}
					
					values_color[ p ] = new THREE.Color();
					values_color[ p ].setRGB(r / topicProductCount, g / topicProductCount, b / topicProductCount);
					//values_color[ p ].setRGB(32, 32, 32);

					// add it to the geometry
					particles.vertices.push(particle);
				}
				
				// create the particle system
				particleSystem =
				  new THREE.ParticleSystem(
				    particles,
				    shaderMaterial);
				
				// add it to the scene
				scene.add(particleSystem);

				//

				renderer = new THREE.WebGLRenderer( { antialias: false, clearColor: 0x333333, clearAlpha: 1, alpha: false } );
				renderer.setSize( window.innerWidth, window.innerHeight );
				renderer.setClearColor( 0, 1 );

				container.appendChild( renderer.domElement );

				//

				window.addEventListener( 'resize', onWindowResize, false );
			}
			
			function setupControls() {
				controls = new THREE.TrackballControls( camera );

				controls.rotateSpeed = 1.0;
				controls.zoomSpeed = 1.2;
				controls.panSpeed = 0.8;

				controls.noZoom = false;
				controls.noPan = false;

				controls.staticMoving = true;
				controls.dynamicDampingFactor = 0.3;

				controls.keys = [ 65, 83, 68 ];

				controls.addEventListener( 'change', render );
			}

			function onWindowResize() {

				windowHalfX = window.innerWidth / 2;
				windowHalfY = window.innerHeight / 2;

				camera.aspect = window.innerWidth / window.innerHeight;
				camera.updateProjectionMatrix();

				renderer.setSize( window.innerWidth, window.innerHeight );
			}

			//

			function animate() {

				requestAnimationFrame( animate );
				controls.update();
				render();
			}

			function render() {

				/*var time = Date.now() * 0.001;

				particleSystem.rotation.x = time * 0.25;
				particleSystem.rotation.y = time * 0.5;*/

				renderer.render( scene, camera );

			}

		</script>

	</body>
</html>
